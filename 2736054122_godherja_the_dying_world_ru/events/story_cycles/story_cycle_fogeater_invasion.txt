namespace = fogeater_invasion

#Events for the mongol invasion Story Cycle

### Spawn Temujin, aka Genghis Khan, with the associated story...
fogeater_invasion.0001 = {
	type = empty
	hidden = yes

	immediate = {
		debug_log = "Fogeaters appeared!"
		debug_log_date = yes
		spawn_scathach_arawn_character_effect = yes

	}
}

# Event for handling new army spawning on succession
fogeater_invasion.0100 = {
	hidden = yes
	immediate = {
		spawn_fogeater_troops_effect = yes
	}
}


##################
# Notification Events
# 1000-1999
##################

### The Khan is dead - a new Khan rises...

fogeater_invasion.1001 = {
	title = fogeater_invasion.1001.title
	
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					target_is_liege_or_above = scope:new_khan
					OR = {
						religion = scope:old_khan.religion
						culture = scope:old_khan.culture
					}
				}
				desc = fogeater_invasion.1001.sympathetic.desc # We have lost a great hero! (/we remain scared) /for allies of faith or subjects
			}
			triggered_desc = {
				trigger = {
					in_diplomatic_range = scope:new_khan
				}
				desc = fogeater_invasion.1001.generic.desc  # Thank [god]. Maybe the next one will be more chill...
			}
			desc = fogeater_invasion.1001.generic.oblivious.desc # Who? /vague info
		}
	}

	theme = war
	override_background = { event_background = wilderness_forest_pine }
	left_portrait = {
		character = scope:new_khan
		animation = personality_bold
	}
	right_portrait = scope:old_khan

	trigger = {
		in_diplomatic_range = scope:new_khan
		NOT = { root = scope:new_khan }
	}
	
	option = {
		name = fogeater_invasion.1001.a
		trigger = {
			scope:old_khan.faith.religion = root.faith.religion
		}
		fallback = yes
	}
	
	option = {
		name = fogeater_invasion.1001.b
		trigger = {
			target_is_liege_or_above = scope:new_khan
		}
	}
	
	option = {
		name = fogeater_invasion.1001.c # Good riddance
		trigger = {
			NOT = {
				scope:old_khan.faith.religion = root.faith.religion
			}
		}
	}
}

### Appearance of Genghis Khan

fogeater_invasion.1002 = {
	type = character_event
	title = fogeater_invasion.1002.t
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					any_realm_province = {
						OR = {
							geographical_region = world_ga_foglands
							geographical_region = world_ga_clanlands
						}
					}
				}
				desc = {
					desc = fogeater_invasion.1002.desc.close
				}
			}
			desc = fogeater_invasion.1002.desc.far
		}
	}
	theme = war
	override_background = { event_background = wilderness_forest_pine }
	left_portrait = scope:scathach_arawn
	
	option = { # Option for characters in Mongolia
		name = {
			trigger = { has_trait = craven }
			text = fogeater_invasion.1002.craven
		}
		name = {
			text = fogeater_invasion.1002.a
		}
		exclusive = yes
		trigger = {
			any_realm_province = {
				geographical_region = world_ga_foglands
			}
		}
		custom_tooltip = fogeater_invasion.1002.scathach_arawn_tt
	}

	option = { # Option for close characters
		name = {
			trigger = { has_trait = craven }
			text = fogeater_invasion.1002.craven
		}
		name = {
			text = fogeater_invasion.1002.b
		}
		trigger = {
			any_realm_province = {
				OR = {
					geographical_region = world_ga_clanlands
					geographical_region = world_ga_marcher_kingdoms
				}
			}
		}
		exclusive = yes
		custom_tooltip = fogeater_invasion.1002.scathach_arawn_tt
	}
	
	option = { # Options for distant characters
		name = {
			text = fogeater_invasion.1002.craven
			trigger = { has_trait = craven }
		}
		name = {
			text = fogeater_invasion.1002.c
		}
		custom_tooltip = fogeater_invasion.1002.scathach_arawn_tt
	}
}


### Breakup of the Mongol Empire
# by Petter Vilberg
#mongol_invasion.1004 = {
#	type = character_event
#	title = mongol_invasion.1004.t
#	desc = mongol_invasion.1004.desc
#	theme = war
#	override_background = {
#		reference = wilderness_steppe
#	}
#	left_portrait = scope:old_mongol_emperor
#	right_portrait = {
#		character = scope:successor_1
#		animation = personality_bold
#	}
#	lower_left_portrait = scope:successor_2
#	lower_center_portrait = scope:successor_3
#	lower_right_portrait = scope:successor_4
#	
#	option = { # The empire will rise again
#		name = mongol_invasion.1004.a
#		trigger = {
#			faith = scope:successor_1.faith
#			OR = {
#				top_liege = scope:old_khan
#				top_liege = scope:successor_1
#				top_liege = scope:successor_2
#				top_liege = scope:successor_3
#				top_liege = scope:successor_4
#			}
#		}
#	}
#
#	option = { # Thank HighGod
#		name = mongol_invasion.1004.b
#		trigger = {
#			always = no
#		}
#		fallback = yes
#	}
#}


### The Empire "breaks up" when it's too small to do so
# by Petter Vilberg
#mongol_invasion.1005 = {
#	type = character_event
#	title = mongol_invasion.1005.t
#	desc = mongol_invasion.1005.desc
#	theme = war
#	override_background = {
#		reference = wilderness_steppe
#	}
#	left_portrait = {
#		character = scope:new_khan
#		animation = personality_bold
#	}
#	right_portrait = scope:old_khan
#
#	trigger = {
#		in_diplomatic_range = scope:new_khan
#		NOT = { root = scope:new_khan }
#	}
#
#	option = {
#		name = mongol_invasion.1005.a
#		custom_tooltip = mongol_invasion.1005.a.tt
#	}
#}


##############################
# Demands for Subjugation
# 2000-2999
# by Petter Vilberg
##############################

# The Khan demands subjugation
fogeater_invasion.2001 = {
	type = letter_event
	opening = fogeater_invasion.2001.opening
	desc = fogeater_invasion.2001.desc
	sender = {
		character = scope:fogeater_emperor
		animation = personality_bold
	}

	trigger = {
		NOT = { is_at_war_with = scope:fogeater_emperor }
		NOT = { root = scope:fogeater_emperor }
	}

	immediate = {
		save_scope_as = demand_recipient
	}

	option = { # Submit
		name = fogeater_invasion.2001.a
		custom_tooltip = fogeater_invasion.2001.a.tt
		hidden_effect = {
			scope:fogeater_emperor = {
				trigger_event = fogeater_invasion.2002
			}
		}
		ai_chance = {
			base = 100
			# More likely for Altaic group to join the big 'un
			modifier = {
				add = 2000
				culture_group = culture_group:gh_fog_eaters_group
			}
			modifier = {
				add = 2000
				religion = religion:fogeater_religion
			}	
			# More likely if you're just a count
			modifier = {
				add = 300
				highest_held_title_tier = tier_county
			}
			# More likely if you're a duke
			modifier = {
				add = 100
				highest_held_title_tier = tier_duchy
			}
			# Likely if you're a Craven
			modifier = {
				factor = 1.2
				has_trait = craven
			}
			# Lower chance if you're decently large
			modifier = {
				factor = 0.5
				realm_size >= 35 # Poland-sized
			}
			# No chance of accepting if you're large
			modifier = {
				factor = 0
				realm_size >= 55 # Hungary-sized
			}
		}
	}

	option = { # Resist
		name = fogeater_invasion.2001.b
		custom_tooltip = fogeater_invasion.2001.b.tt
		add_internal_flag = dangerous
		hidden_effect = {
			scope:fogeater_emperor = {
				trigger_event = fogeater_invasion.2003
			}
		}
		ai_chance = {
			base = 100
		}
	}
}

# Subjugation accepted
fogeater_invasion.2002 = {
	type = letter_event
	opening = fogeater_invasion.2002.opening
	desc = fogeater_invasion.2002.desc
	sender = scope:demand_recipient

	immediate = {
		create_title_and_vassal_change = {
			type = swear_fealty
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		scope:demand_recipient = {
			change_liege = {
				liege = root
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone accepted Mongol subjugation"
		debug_log_scopes = yes
	}

	option = { # Wise choice
		name = fogeater_invasion.2002.a
	}
}

# Subjugation refused
fogeater_invasion.2003 = {
	type = letter_event
	opening = fogeater_invasion.2003.opening
	desc = fogeater_invasion.2003.desc
	sender = {
		character = scope:demand_recipient
		animation = personality_bold
	}

	immediate = {
		hidden_effect = {
			scope:demand_recipient.primary_title = {
				save_scope_as = target_title
			}
		}
		# Remove from the list blocking war declarations
		remove_list_variable = {
			name = subjugation_offer_under_consideration
			target = scope:demand_recipient
		}

		debug_log = "Someone refused Mongol subjugation"
		debug_log_scopes = yes
	}

	option = { # War it is
		name = fogeater_invasion.2003.a
		if = {
			limit = {
				exists = scope:target_title.empire
			}
			start_war = {
				cb = fogeater_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.empire
			}
		}
		else = {
			debug_log = "Failed to find a target empire for a Mongol invasion!"
			debug_log_scopes = yes

			start_war = {
				cb = fogeater_realm_invasion_war
				target = scope:target_title.holder
				target_title = scope:target_title.holder.capital_province.empire
			}
		}
	}
}



### Destroy the Mongol Empire title if appropriate
#mongol_invasion.9999 = {
#	type = character_event
#	hidden = yes
#
#	trigger = {
#		exists = global_var:mongol_empire_was_broken_up
#	}
#	
#	immediate = {
#		if = {
#			limit = {
#				any_held_title = {
#					this = title:e_mongolia
#				}
#				any_held_title = {
#					this = title:e_mongol_empire
#				}
#			}
#		}
#		title:e_mongol_empire = {
#			every_in_de_jure_hierarchy = {
#				continue = {
#					tier > tier_kingdom
#				}
#				limit = {
#					tier = tier_kingdom
#				}
#				set_de_jure_liege_title = title:e_mongolia
#			}
#		}
#		destroy_title = title:e_mongol_empire
#	}
#} 



####maintenace event

fogeater_invasion.9000 = { ###this event will launch invasion
	type = empty
	hidden = yes

	immediate = {
		if = {
			limit = {
				NOT = { has_global_variable = fogeater_invasion_triggered }
				NOT = { has_game_rule = never_fogeater_invasion }
			}
			
			if = {
				limit = {
					has_game_rule = default_fogeater_invasion
				}
				trigger_event = {
					id = fogeater_invasion.0001
					years = { 120 150 }
				}
				set_global_variable = {
					name = fogeater_invasion_triggered
					value = yes
				}
			}		
			else_if = { 
				limit = {
					has_game_rule = random_fogeater_invasion
				}
				if = {
					limit = {
						game_start_date < 1260.1.1
					}
					trigger_event = {
						id = fogeater_invasion.0001
						years = { 20 250 }
					}
					set_global_variable = {
						name = fogeater_invasion_triggered
						value = yes
					}				
				}
			}
		}
	}
}

fogeater_invasion.9001 = {
	hidden = yes
	
	immediate = {
		fogeater_ai_effect = yes
	}
}









