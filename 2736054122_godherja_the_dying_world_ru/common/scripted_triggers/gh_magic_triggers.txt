spell_requires_trait_rank = {
	OR = {
		has_trait_rank = {
			trait = $TRAIT_NAME$
			rank > $RANK$
		}
		any_councillor = {
			is_performing_council_task = task_court_mage_cast_spells
			has_trait_rank = {
				trait = $TRAIT_NAME$
				rank > $RANK$
			}
		}
	}
}

spell_requires_court_mage_trait_rank = {
	any_councillor = {
		is_performing_council_task = task_court_mage_cast_spells
		has_trait_rank = {
			trait = $TRAIT_NAME$
			rank > $RANK$
		}
	}
}

spell_requires_court_mage_culture_group = {
	any_councillor = {
		is_performing_council_task = task_court_mage_cast_spells
		has_culture_group = $CULTURE_GROUP$
	}
}

spell_requires_faith = {
	has_faith = $FAITH$
}

spell_requires_perk = {	# If I ever figure out how to get it working with unlanded mages
	has_perk = $PERK_NAME$
}

spell_magic_cost_raw = {
	OR = {
		trigger_if = {
			limit = { has_variable = magic_counter } 
			NOT = {
				any_councillor = {
					is_performing_council_task = task_court_mage_cast_spells
				}
			}
			var:magic_counter >= $COST$
		}
		trigger_else = {
			always = no
		}
		any_councillor = {
			trigger_if = {
				limit = { 
					is_performing_council_task = task_court_mage_cast_spells
					exists = var:magic_counter 
				}
				var:magic_counter >= root.$COST$
			}
			trigger_else = {
				always = no
			}
		}
	}
}

spell_magic_cost_by_tier = {
	spell_magic_cost_raw = {
		COST = tier_$TIER$_spell
	}
}

conservative_spell_magic_cost_raw = {
	OR = {
		trigger_if = {
			limit = { has_variable = magic_counter } 
			NOT = {
				any_councillor = {
					is_performing_council_task = task_court_mage_cast_spells
				}
			}
			magic_counter_double >= $COST$
		}
		trigger_else = {
			always = no
		}
		any_councillor = {
			trigger_if = {
				limit = { 
					is_performing_council_task = task_court_mage_cast_spells
					exists = var:magic_counter 
				}
				magic_counter_double >= root.$COST$
			}
			trigger_else = {
				always = no
			}
		}
	}
}

conservative_spell_magic_cost_by_tier = {
	conservative_spell_magic_cost_raw = {
		COST = tier_$TIER$_spell
	}
}

can_access_magic = {
	is_adult = yes
	has_trait_with_flag = enables_magic
	NOT = { has_trait_with_flag = can_not_access_magic }
}

can_access_magic_including_children = {
	has_trait_with_flag = enables_magic
	NOT = { has_trait_with_flag = can_not_access_magic }
}

############################
# MOON TRIGGERS			   #
############################

is_any_good_moon_trigger = {
	OR = {
		is_full_moon_trigger = yes
		is_gibbous_moon_trigger = yes
	}
}

is_any_bad_moon_trigger = {
	OR = {
		is_new_moon_trigger = yes
		is_crescent_moon_trigger = yes
	}
}

is_gibbous_moon_trigger = {
	exists = global_var:current_moon_phase
	global_var:current_moon_phase = {
		OR = {
			var:moon_phase_name = flag:waxing_gibbous_moon
			var:moon_phase_name = flag:waning_gibbous_moon
		}
	}
}

is_quarter_moon_trigger = {
	exists = global_var:current_moon_phase
	global_var:current_moon_phase = {
		OR = {
			var:moon_phase_name = flag:first_quarter_moon
			var:moon_phase_name = flag:last_quarter_moon
		}
	}
}

is_crescent_moon_trigger = {
	exists = global_var:current_moon_phase
	global_var:current_moon_phase = {
		OR = {
			var:moon_phase_name = flag:waxing_crescent_moon
			var:moon_phase_name = flag:waning_crescent_moon
		}
	}
}

is_full_moon_trigger = {
	exists = global_var:current_moon_phase
	global_var:current_moon_phase = {
		var:moon_phase_name = flag:full_moon
	}
}

is_new_moon_trigger = {
	exists = global_var:current_moon_phase
	global_var:current_moon_phase = {
		var:moon_phase_name = flag:new_moon
	}
}

dead_magic_moon_lvl3 = {
	OR = {
		is_any_good_moon_trigger = yes
		NOT = {
			var:magic_lvl = 3
		}
	}
}

dead_magic_moon_lvl2 = {
	OR = {
		is_any_bad_moon_trigger = no
		NOT = {
			var:magic_lvl = 2
		}
	}
}

############################
# MAGIC EDUCATION UPGRADES #
############################

can_level_up_magic = {
	trigger_if = {
		limit = { has_trait = magic_good_20 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_19 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_18 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_17 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_16 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_15 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_14 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_13 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_12 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_11 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_10 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_9 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_8 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_7 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_6 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_5 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_4 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_3 }
		NOT = { has_trait = education_$MAGIC_TYPE$_4 }	# No point in levelling up anymore if at max
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_2 }
		NOR = { 
			has_trait = education_$MAGIC_TYPE$_4
			has_trait = education_$MAGIC_TYPE$_3
		}
	}
	trigger_else_if = {
		limit = { has_trait = magic_good_1 }
		NOR = { 
			has_trait = education_$MAGIC_TYPE$_4
			has_trait = education_$MAGIC_TYPE$_3
			has_trait = education_$MAGIC_TYPE$_2
		}
	}
	trigger_else = {
		always = no
	}
}

has_leveled_up = {
	trigger_if = {
		limit = { exists = var:$MAGIC_TYPE$_education_progress }
		AND = {
			var:$MAGIC_TYPE$_education_progress >= $THRESHOLD$
			age >= $MIN_AGE$
			NOT = {	# has_trait_rank is wonky since the ranks for magic education start at lvl 2, in my experience
				has_trait_rank = {
					trait = education_$MAGIC_TYPE$
					rank >= $RANK$
				}
			}
		}
	}
	trigger_else = { always = no }
}

has_magic_education_trait_rank = {
	OR = {
		has_trait = education_mixed_magic_$RANK$
		has_trait = education_dead_magic_$RANK$
		has_trait = education_living_magic_$RANK$
	}
}

can_have_court_magi_trigger = {
	NOT = { has_trait = gh_wasteland }
	OR = {
		has_trait = cynical
		faith = {
			NOT = {
				has_doctrine = doctrine_magic_crime
			}
		}
	}
}

glimpse_reality_choice_not_taken = {
	NOR = {
		is_target_in_variable_list = {
			name = glimpse_reality_choices
			target = flag:$OPTION$
		}
		#has_character_flag = $OPTION$
	}
}